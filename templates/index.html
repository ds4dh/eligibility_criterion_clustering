<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT Eligibility Visualization</title>
    <link rel="stylesheet" href="/ct-risk/cluster/static/style.css">
</head>
<body>
    <h1>CT Eligibility Visualization</h1>
    <div class="button-row">
        <a href="https://github.com/ds4dh/eligibility_criterion_clustering" target="_blank" class="action-button github-button">Github</a>
        <a href="https://www.medrxiv.org/content/10.1101/2024.10.08.24315075v1" target="_blank" class="action-button paper-button">Paper</a>
    </div>    

    <form id="visualizationForm">
        <label for="DEMO_MODE">Demo mode:</label>
        <select id="DEMO_MODE" name="DEMO_MODE" required>
            <option value="nct_id">NCT ID</option>
            <option value="ct_file">CT file</option>
            <option value="ct_info">CT info</option>
        </select><br><br>

        <div id="nctInput" class="input-section">
            <label for="TARGET_NCT_ID">Target NCT ID:</label>
            <input
                type="text"
                id="TARGET_NCT_ID"
                name="TARGET_NCT_ID"
                value="NCT00306969"
                onfocus="clearDefault(this)" 
                onblur="restoreDefault(this)"
            ><br><br>
        </div>

        <div id="fileInput" class="input-section hidden">
            <label for="TARGET_CT_FILE">Upload target CT file (JSON format):</label>
            <input type="file" id="TARGET_CT_FILE" name="TARGET_CT_FILE" accept=".json"><br><br>
        </div>

        <div id="ctInfoInput" class="input-section hidden">
            <label for="CHOSEN_PHASES">Target phases:</label>
            <input type="text" id="CHOSEN_PHASES" name="CHOSEN_PHASES" value="phase1,phase2"><br><br>
            <label for="CHOSEN_COND_IDS">Target condition ID(s):</label>
            <input type="text" id="CHOSEN_COND_IDS" name="CHOSEN_COND_IDS" value="C04.557.386,C15.604.515.569,C20.683.515.761"><br><br>
            <label for="CHOSEN_ITRV_IDS">Target intervention ID(s):</label>
            <input type="text" id="CHOSEN_ITRV_IDS" name="CHOSEN_ITRV_IDS" value="D02.455.426.559.847.638.960.423,D04.615"><br><br>
        </div>

        <button type="submit" id="visualizeButton">
            <span class="button-text">Visualize</span>
            <div class="spinner"></div>
        </button>
    </form>

    <div id="logContainer" class="section hidden">
        <h2>Visualizing...</h2>
        <p id="logOutput"></p>
    </div>

    <div id="visualizationContainer" class="section hidden">
        <h2>Visualization</h2>
        <iframe id="visualizationFrame" hidden></iframe>
    </div>

    <script>
        const demoModeSelect = document.getElementById('DEMO_MODE');
        const nctInput = document.getElementById('nctInput');
        const fileInput = document.getElementById('fileInput');
        const ctInfoInput = document.getElementById('ctInfoInput');
        let pollingInterval = null;

        demoModeSelect.addEventListener('change', () => {
            const selectedMode = demoModeSelect.value;
            nctInput.classList.toggle('hidden', selectedMode !== 'nct_id');
            fileInput.classList.toggle('hidden', selectedMode !== 'ct_file');
            ctInfoInput.classList.toggle('hidden', selectedMode !== 'ct_info');
        });

        document.getElementById('visualizationForm').addEventListener('submit', async (event) => {
            event.preventDefault();

            const formData = new FormData(event.target);
            const demoMode = formData.get('DEMO_MODE');
            const logOutput = document.getElementById('logOutput');
            const visualizationFrame = document.getElementById('visualizationFrame');
            const logContainer = document.getElementById('logContainer');
            const visualizationContainer = document.getElementById('visualizationContainer');
            const visualizeButton = document.getElementById('visualizeButton');

            logContainer.classList.remove('hidden');
            visualizationContainer.classList.add('hidden');
            visualizationFrame.hidden = true;
            logOutput.textContent = "";

            visualizeButton.disabled = true;
            visualizeButton.classList.add('loading', 'disabled');
            visualizeButton.querySelector('.button-text').textContent = 'Generating...';

            const requestData = {};
            if (demoMode === 'ct_file') {
                const file = document.getElementById('TARGET_CT_FILE').files[0];
                if (!file) return alert('Please upload a file.');
                requestData.TARGET_CT_DICT = JSON.parse(await file.text());
            } else if (demoMode === 'nct_id') {
                requestData.TARGET_NCT_ID = formData.get('TARGET_NCT_ID');
            } else if (demoMode === 'ct_info') {
                requestData.CHOSEN_PHASES = formData.get('CHOSEN_PHASES').split(',').map(s => s.trim());
                requestData.CHOSEN_COND_IDS = formData.get('CHOSEN_COND_IDS').split(',').map(s => s.trim());
                requestData.CHOSEN_ITRV_IDS = formData.get('CHOSEN_ITRV_IDS').split(',').map(s => s.trim());
            }
            requestData.DEMO_MODE = demoMode;

            startPolling(logOutput);

            try {
                const response = await fetch('/ct-risk/cluster/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                });
                if (response.ok) {
                    const result = await response.json();
                    visualizationFrame.src = result.html_path;
                    visualizationFrame.hidden = false;
                    logContainer.classList.add('hidden');
                    visualizationContainer.classList.remove('hidden');
                } else throw new Error('Visualization failed');
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                visualizeButton.disabled = false;
                visualizeButton.classList.remove('loading', 'disabled');
                visualizeButton.querySelector('.button-text').textContent = 'Visualize';
                clearInterval(pollingInterval);
            }
        });

        function startPolling(logOutput) {
            clearInterval(pollingInterval);
            pollingInterval = setInterval(async () => {
                if (document.hidden) return;  // stop polling if page is hidden
                const response = await fetch('/ct-risk/cluster/get-latest-log');
                if (response.ok) {
                    const logResult = await response.json();
                    logOutput.textContent = logResult.log;
                }
            }, 1000);
        }

        // Handle visibility changes
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) {
                clearInterval(pollingInterval);
            } else {
                startPolling(document.getElementById('logOutput'));
            }
        });

        // Cleanup on page unload
        window.addEventListener("beforeunload", () => {
            navigator.sendBeacon("/cleanup-session-log");
        });

        document.getElementById('visualizationFrame').addEventListener('load', function () {
            const iframe = this;

            // Function to scale the content inside the iframe
            function scaleIframeContent() {
                const iframeContent = iframe.contentDocument || iframe.contentWindow.document;
                const contentBody = iframeContent.body;

                if (!contentBody) return; // ensure the content is loaded
                
                iframeContent.documentElement.style.overflow = 'hidden';
                contentBody.style.overflow = 'hidden';
                contentBody.style.margin = '0';
                contentBody.style.padding = '0';
                
                const contentWidth = contentBody.scrollWidth;
                const scaleFactor = iframe.clientWidth / contentWidth;
                contentBody.style.transform = `scale(${scaleFactor})`;
                contentBody.style.transformOrigin = 'center';
                
                const scaledHeight = contentBody.scrollHeight * scaleFactor;
                iframe.style.height = `${Math.ceil(scaledHeight)}px`;
                iframe.style.overflow = 'hidden';
            }
            scaleIframeContent();
        });

        function clearDefault(element) {
            if (element.value === element.defaultValue) element.value = "";
        }

        function restoreDefault(element) {
            if (!element.value.trim()) element.value = element.defaultValue;
        }
    </script>
</body>
</html>
